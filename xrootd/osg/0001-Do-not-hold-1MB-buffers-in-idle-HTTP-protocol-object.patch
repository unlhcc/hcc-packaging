From 2b41c29b82697ec98b3246c7ccd68b39cc1e8c16 Mon Sep 17 00:00:00 2001
From: John Thiltges <jthiltges2@unl.edu>
Date: Tue, 19 Mar 2019 10:22:00 -0500
Subject: [PATCH] Do not hold 1MB buffers in idle HTTP protocol objects

---
 src/XrdHttp/XrdHttpProtocol.cc | 13 ++++++++++---
 1 file changed, 10 insertions(+), 3 deletions(-)

diff --git a/src/XrdHttp/XrdHttpProtocol.cc b/src/XrdHttp/XrdHttpProtocol.cc
index e7068978..0445f99a 100644
--- a/src/XrdHttp/XrdHttpProtocol.cc
+++ b/src/XrdHttp/XrdHttpProtocol.cc
@@ -251,6 +251,12 @@ XrdProtocol *XrdHttpProtocol::Match(XrdLink *lp) {
   else
     hp->ishttps = myishttps;
 
+  // Allocate 1MB buffer from pool
+  if (!hp->myBuff) {
+    hp->myBuff = BPool->Obtain(1024 * 1024);
+  }
+  hp->myBuffStart = hp->myBuffEnd = hp->myBuff->buff;
+
   // Bind the protocol to the link and return the protocol
   //
   hp->Link = lp;
@@ -1797,10 +1803,11 @@ void XrdHttpProtocol::Reset() {
   CurrentReq.reset();
   CurrentReq.reqstate = 0;
 
-  if (!myBuff) {
-    myBuff = BPool->Obtain(1024 * 1024);
+  if (myBuff) {
+    BPool->Release(myBuff);
+    myBuff = 0;
   }
-  myBuffStart = myBuffEnd = myBuff->buff;
+  myBuffStart = myBuffEnd = 0;
 
   DoingLogin = false;
 
-- 
2.17.2

